@page "/admin/games"

@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<Container Condition="Games?.Any() == true">
    <table>
        <thead>
            <tr>
                <th>Id</th>
                <th>Nom</th>
                <th>Date</th>
                <th>Cartes</th>
                <th>Joueurs</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <Repeater Items="Games" Context="game">
                <tr>
                    <td>@game.Id</td>
                    <td>@game.Name</td>
                    <td>@game.Date.ToShortDateString()</td>
                    <td>@(new MarkupString(string.Join("<br />", game.Challenges.Select(c => c.MapName))))</td>
                    <td>@(new MarkupString(string.Join("<br />", game.Challenges.First().PlayerScores.Select(p => p.PlayerName))))</td>
                    <td>
                        <button @onclick="(() => EditGame(game.Id))">Editer</button>
                        <button @onclick="(() => DeleteGameAsync(game.Id))">Supprimer</button>
                    </td>
                </tr>
            </Repeater>
        </tbody>
    </table>
</Container>

<button @onclick="ShowGameCreation">Créer</button>

<Container Condition="ShowEditForm">
    <EditForm Model="Game" OnValidSubmit="CreateOrUpdateGameAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <Container Condition="!string.IsNullOrWhiteSpace(Error)">
            <p>@Error</p>
        </Container>

        <InputText id="name" @bind-Value="Game.Name" />
        <InputDate id="date" @bind-Value="Game.Date" />

        <hr />
        <Repeater Items="@Game.Challenges" Context="challenge">
            <div>
                <InputText @bind-Value="challenge.Link" />
                <InputSelect @bind-Value="challenge.MapId">
                    <option value="0">—</option>
                    <Repeater Items="@Maps" Context="map">
                        <option value="@map.Id">@map.Name</option>
                    </Repeater>
                </InputSelect>
                <button @onclick="() => Game.Challenges.Remove(challenge)" type="button">X</button>
            </div>
        </Repeater>
        <button @onclick="() => Game.Challenges.Add(new ChallengeCreateOrEditDto())" type="button">Ajouter carte</button>

        <hr />
        <CheckboxList Data="@Players" LabelSelector="@(p => p.Name)" IdSelector="@(p => p.Id)" SelectedIds="@Game.PlayerIds" />

        <button type="submit">Valider</button>
    </EditForm>
</Container>
